# Nginx 配置参考

> **注意**: 使用宝塔面板时，通过面板界面配置即可，无需手动编辑此文件。
>
> 本文件仅作为参考，展示完整的 Nginx 配置。

---

## 通过宝塔面板配置（推荐）

### 1. 添加网站
- 域名: `api.webspark.club`
- 根目录: `/www/wwwroot/webspark/backend`
- PHP: 纯静态

### 2. 配置反向代理
- 代理名称: `webspark-api`
- 目标 URL: `http://127.0.0.1:3001`
- 发送域名: `$host`

### 3. 申请 SSL 证书
- 选择 Let's Encrypt
- 勾选域名
- 开启强制 HTTPS

---

## 完整配置文件（参考）

```nginx
# HTTP -> HTTPS 重定向
server {
    listen 80;
    server_name api.webspark.club;
    return 301 https://$server_name$request_uri;
}

# HTTPS 主配置
server {
    listen 443 ssl http2;
    server_name api.webspark.club;

    # SSL 配置（宝塔自动配置）
    ssl_certificate /www/server/panel/vhost/cert/api.webspark.club/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/api.webspark.club/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;

    # 基础配置
    client_max_body_size 10M;

    # Gzip 压缩
    gzip on;
    gzip_types application/json application/javascript text/xml;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=63072000";

    # API 代理（所有请求转发到 Node.js）
    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 健康检查（关闭日志）
    location /health {
        access_log off;
        proxy_pass http://127.0.0.1:3001;
    }

    # 日志配置
    access_log /www/wwwroot/webspark/backend/logs/nginx_access.log;
    error_log /www/wwwroot/webspark/backend/logs/nginx_error.log;
}
```

---

## 重要说明

### ⚠️ 已移除本地静态文件服务

本项目已将图片存储迁移到 Cloudflare R2，因此：

- ❌ 不再需要配置 `/uploads` 路径
- ❌ 不再需要 `alias /www/wwwroot/webspark/backend/uploads`
- ✅ 所有图片由 R2 CDN 提供（更快、更便宜）

**如果你看到旧文档提到配置 `/uploads`，请忽略。**

---

## 性能优化（可选）

### 启用 API 缓存（5分钟）

在 `location /` 块中添加：

```nginx
location /api/ {
    # 缓存配置
    expires 5m;
    add_header Cache-Control "public, must-revalidate";

    # 原有代理配置...
    proxy_pass http://127.0.0.1:3001;
    # ...
}
```

### 限流配置

在 `http` 块中添加：

```nginx
# 在 server 块外定义
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;

# 在 location / 块中使用
location / {
    limit_req zone=api_limit burst=20 nodelay;
    # ...
}
```

---

## 故障排查

### 502 Bad Gateway

**原因**: Node.js 服务未运行

**解决**:
```bash
pm2 status
pm2 start ecosystem.config.js
```

### SSL 证书无法申请

**原因**: 80 端口被占用或域名未解析

**解决**:
1. 确认域名 DNS 已解析
2. 检查 80 端口：`netstat -tulpn | grep :80`
3. 通过宝塔面板重新申请

### 上传文件 413 错误

**原因**: 文件大小超限

**解决**: 修改 `client_max_body_size` 为更大值（如 20M）

---

**提示**: 使用宝塔面板时，大部分配置会自动完成，无需手动编辑文件。
